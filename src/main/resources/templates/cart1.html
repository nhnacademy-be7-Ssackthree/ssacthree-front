<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{common/config :: config}">
  <title>장바구니</title>
</head>
<body>

<header th:replace="~{common/header :: header}"></header>

<div class="container mt-5">
  <h2>장바구니</h2>

  <div class="cart-items">
    <!-- 장바구니에 아이템이 없을 때 보여줄 메시지 -->
    <div th:if="${#lists.isEmpty(cartItems)}" class="alert alert-warning">장바구니에 아이템이 없습니다.</div>

    <!-- 장바구니 아이템이 있을 때 보여줄 리스트 -->
    <div th:each="item : ${cartItems}" class="row cart-item border-bottom py-3" th:data-item-id="${item.id}">
      <div class="col-md-2">
        <img th:src="@{/images/book1.jpg}" class="img-fluid" alt="Book Image">
      </div>
      <div class="col-md-4">
        <h5 th:text="${item.title}">책 제목</h5>
      </div>
      <div class="col-md-3">
        <div class="input-group">
          <button class="btn btn-outline-secondary decrease-qty" type="button">-</button>
          <input type="text" class="form-control text-center qty-input" th:value="${item.quantity}" readonly>
          <button class="btn btn-outline-secondary increase-qty" type="button">+</button>
        </div>
      </div>
      <div class="col-md-2">
        <span class="price" th:text="${item.price} + '원'">20,000원</span>
      </div>
      <div class="col-md-1">
        <button class="btn btn-danger remove-item">X</button>
      </div>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-md-6">
      <h4>배송 정보</h4>
      <p>무료 배송 - 2~3 영업일 소요</p>
    </div>
    <div class="col-md-6 text-right">
      <h4>총 금액: <span id="total-price" th:text="${totalPrice} + '원'">20,000원</span></h4>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-md-6">
      <h4>결제 방법</h4>
      <ul class="list-unstyled">
        <li><img src="images/visa.jpg" alt="Visa" width="50"> Visa</li>
        <li><img src="images/mastercard.jpg" alt="MasterCard" width="50"> MasterCard</li>
        <li><img src="images/paypal.jpg" alt="PayPal" width="50"> PayPal</li>
      </ul>
    </div>
    <div class="col-md-6 text-right">
      <!-- 장바구니 항목을 hidden input으로 추가 -->
      <form id="cartForm" action="/" method="get">
        <button type="submit" id="continue-shopping" class="btn btn-light">쇼핑 계속하기</button>
      </form>
    </div>
  </div>
</div>

<footer th:replace="~{common/footer :: footer}"></footer>

<script th:src="@{/js/jquery-1.11.0.min.js}"></script>
<script th:src="@{/js/script.js}"></script>

<script th:inline="javascript">
  /*
 * `JSON.stringify()`로 데이터 전달
 * Thymeleaf가 `cartItems`를 직접 객체로 전달하도록 수정
 */
  let cartItems = /*[[${cartItems}]]*/ '[]';
  cartItems = JSON.parse(cartItems); // JSON 형식으로 파싱
  console.log("Initialized cartItems:", cartItems);
</script>

<script>
  $(document).ready(function () {
    // 수량 증가 기능
    $('.increase-qty').click(function () {
      let qtyInput = $(this).siblings('.qty-input');
      let currentQty = parseInt(qtyInput.val());
      qtyInput.val(currentQty + 1);

      // cartItems 업데이트
      let itemId = $(this).closest('.cart-item').data('item-id');
      updateCartItemQuantity(itemId, currentQty + 1);

      updateTotal();
      saveCartToRedis(); // 수량이 변경될 때마다 Redis에 저장
    });

    // 수량 감소 기능
    $('.decrease-qty').click(function () {
      let qtyInput = $(this).siblings('.qty-input');
      let currentQty = parseInt(qtyInput.val());
      if (currentQty > 1) {
        qtyInput.val(currentQty - 1);

        // cartItems 업데이트
        let itemId = $(this).closest('.cart-item').data('item-id');
        updateCartItemQuantity(itemId, currentQty - 1);
      }

      updateTotal();
      saveCartToRedis(); // 수량이 변경될 때마다 Redis에 저장
    });

    // cartItems에서 수량 업데이트 함수
    function updateCartItemQuantity(itemId, newQuantity) {
      let item = cartItems.find(item => item.id === itemId);
      if (item) {
        item.quantity = newQuantity;
        console.log(`Item ID: ${itemId}, New Quantity: ${newQuantity}`);
      } else {
        console.error(`Item with ID ${itemId} not found`);
      }
    }

    // 총 금액 업데이트 함수
    function updateTotal() {
      let totalPrice = 0;
      $('.cart-item').each(function () {
        let qty = parseInt($(this).find('.qty-input').val());
        let price = parseFloat($(this).find('.price').text().replace(',', '').replace('원', ''));
        totalPrice += qty * price;
      });
      $('#total-price').text(totalPrice.toLocaleString('ko-KR') + '원');
    }

    // Redis에 장바구니 저장하는 함수
    function saveCartToRedis() {
      console.log('Saving cartItems:', cartItems);
      $.ajax({
        url: '/shop/save',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(cartItems),
        success: function () {
          console.log('Redis에 장바구니가 저장되었습니다.');
        },
        error: function () {
          console.error('Redis에 장바구니 저장 실패');
        }
      });
    }
  });
</script>

</body>
</html>